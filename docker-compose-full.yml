version: '3'

services:

  redis:
    image: redis:3.2-alpine
    environment:
      - ULIMIT=65536
    volumes:
      - ./configuration/redis:/usr/local/etc/redis:ro
      - ./data/redis:/data
    ports:
      - "6379:6379"

#  rabbitmq:
#    image: rabbitmq:3-alpine
#    environment:
#      - ULIMIT=65536
#      - RABBITMQ_DEFAULT_VHOST=/sensu
#      - RABBITMQ_DEFAULT_USER=sensu
#      - RABBITMQ_DEFAULT_PASS=secret
#    volumes:
#      - ./data/rabbitmq:/var/lib/rabbitmq
#    ports:
#      - "4369"
#      - "5671"
#      - "5672"
#      - "25672"

  rabbitmq:
    image: rabbitmq:3-alpine
    volumes:
      - ./configuration/rabbitmq/rabbitmq.config:/etc/rabbitmq/rabbitmq.config
      - ./data/rabbitmq:/var/lib/rabbitmq
      - ./sensu_ssl_tool:/etc/sensu_ssl:ro
    ports:
      - "4369:4369"
      - "5671:5671"
      - "5672:5672"
      - "25672:25672"

  sensu:
    build: ./application/sensu/.
    depends_on:
      - rabbitmq
      - redis

  sensu-server:
    image: sensustack_sensu
    #image: sensu
    volumes:
      - ./configuration/sensu:/etc/sensu
      - ./sensu_ssl_tool:/etc/sensu_ssl:ro
    command: ["/opt/sensu/bin/sensu-server", "-d", "/etc/sensu"]
    depends_on:
      - sensu
      - rabbitmq
      - redis

  sensu-api:
    image: sensustack_sensu
    #image: sensu
    volumes:
      - ./configuration/sensu:/etc/sensu
      - ./sensu_ssl_tool:/etc/sensu_ssl:ro
    command: ["/opt/sensu/bin/sensu-api", "-d", "/etc/sensu"]
    depends_on:
      - sensu
      - rabbitmq
      - redis
    ports:
     - "4567:4567"

  sensu-dashboard:
    build: ./application/sensu-dashboard/.
    volumes:
      - ./configuration/sensu-dashboard:/etc/uchiwa
    command: ["/opt/uchiwa/bin/uchiwa", "-c", "/etc/uchiwa/uchiwa.json"]
    depends_on:
      - sensu-api
    ports:
      - "3000:3000"

#  sensu-client:
#    #image: sensustack_sensu
#    image: sensu
#    volumes:
#      - ./configuration/sensu:/etc/sensu
#    command: ["/opt/sensu/bin/sensu-client", "-d", "/etc/sensu"]
#    depends_on:
#      - rabbitmq
